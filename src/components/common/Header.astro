---
const { pathname } = Astro.url;

const links = [
  { label: "Explore", href: "/explore", active: pathname === "/explore" },
  { label: "Pricing", href: "/pricing", active: pathname === "/pricing" },
  { label: "Docs", href: "/docs", active: pathname === "/docs" },
];
---

<!-- Command Deck Header (Fixed Full Width) -->
<nav
  class="fixed top-0 left-0 w-full z-50 bg-black/50 backdrop-blur-xl border-b border-white/5 px-4 md:px-8 py-4 flex justify-between items-center transition-all duration-300"
>
  <!-- Logo / Home -->
  <a
    href="/"
    class="flex items-center gap-3 px-4 py-2 rounded-full hover:bg-white/5 transition-colors group"
  >
    <div class="relative w-2 h-2">
      <div
        class="absolute inset-0 bg-emerald-500 rounded-full animate-ping opacity-75"
      >
      </div>
      <div class="relative w-2 h-2 bg-emerald-500 rounded-full"></div>
    </div>
    <span
      class="font-mono text-[10px] font-bold tracking-widest uppercase text-white transition-colors"
    >
      VXLVERSE
    </span>
  </a>

  <!-- Navigation Links -->
  <div class="hidden md:flex items-center gap-1">
    {
      links.map((link) => (
        <a
          href={link.href}
          class={`relative px-4 py-2 rounded-full text-[10px] uppercase font-bold tracking-widest transition-all duration-300 group overflow-hidden ${
            link.active
              ? "text-black bg-white"
              : "text-zinc-400 hover:text-white hover:bg-white/5"
          }`}
        >
          <span class="relative z-10">{link.label}</span>
        </a>
      ))
    }
  </div>

  <!-- Action Button / Auth -->
  <div class="flex items-center gap-4" x-data>
    <!-- Profile / Logout (Visible when logged in) -->
    <template x-if="$store.auth.isLoggedIn">
      <div class="flex items-center gap-2">
        <div
          class="relative group cursor-pointer"
          @click="$store.auth.logout()"
        >
          <img
            :src="$store.auth.avatarUrl"
            class="w-8 h-8 rounded-full border border-white/20 hover:border-red-500 transition-colors"
            alt="User Avatar"
          />
          <div
            class="absolute top-full right-0 mt-2 px-3 py-1 bg-red-500/90 text-white text-[9px] font-bold uppercase rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap"
          >
            Logout
          </div>
        </div>
        <a
          href="/editor"
          class="hidden md:flex group relative px-6 py-2 bg-white text-black rounded-full overflow-hidden items-center gap-2 transition-transform hover:scale-105"
        >
          <span
            class="relative z-10 text-[10px] font-bold uppercase tracking-widest"
            >Create</span
          >
        </a>
      </div>
    </template>

    <!-- Login Button (Visible when logged out) -->
    <template x-if="!$store.auth.isLoggedIn">
      <a
        href="/login"
        class="group relative px-6 py-2.5 bg-white text-black rounded-full overflow-hidden flex items-center gap-2 transition-all hover:scale-105 hover:shadow-[0_0_20px_rgba(255,255,255,0.3)] cursor-pointer"
      >
        <span
          class="relative z-10 text-[10px] font-black uppercase tracking-widest"
          >Get Started</span
        >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-3 h-3 relative z-10 transition-transform group-hover:translate-x-1"
        >
          <path
            fill-rule="evenodd"
            d="M12.97 3.97a.75.75 0 011.06 0l7.5 7.5a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 11-1.06-1.06l6.22-6.22H3a.75.75 0 010-1.5h16.19l-6.22-6.22a.75.75 0 010-1.06z"
            clip-rule="evenodd"></path>
        </svg>
        <div
          class="absolute inset-0 bg-gradient-to-r from-zinc-100 to-white opacity-0 group-hover:opacity-100 transition-opacity"
        >
        </div>
      </a>
    </template>
  </div>

  <!-- Mobile Menu Button -->
  <button
    id="mobile-menu-btn"
    class="md:hidden px-4 text-white focus:outline-none"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-5 h-5"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
    </svg>
  </button>
</nav>

<!-- Mobile Overlay (unchanged logic, refined style) -->
<div
  id="mobile-menu"
  class="fixed inset-0 bg-[#050505]/95 backdrop-blur-3xl z-40 flex flex-col items-center justify-center gap-8 opacity-0 pointer-events-none transition-all duration-500 scale-95"
>
  <button
    id="close-menu-btn"
    class="absolute top-8 right-8 text-zinc-500 hover:text-white transition-colors"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-8 h-8"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M6 18 18 6M6 6l12 12"></path>
    </svg>
  </button>

  {
    links.map((link) => (
      <a
        href={link.href}
        class="text-3xl font-black uppercase tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-zinc-500 hover:to-white transition-all transform hover:scale-110"
      >
        {link.label}
      </a>
    ))
  }
  <a
    href="/editor"
    class="mt-8 px-12 py-4 bg-white text-black font-bold uppercase tracking-widest rounded-full hover:scale-105 transition-transform"
    >Launch Engine</a
  >
</div>

<script>
  import { pb } from "../../lib/pb";
  import Alpine from "alpinejs";

  // Ensure Alpine is only initialized once
  if (!window.Alpine) {
    window.Alpine = Alpine;

    Alpine.store("auth", {
      isLoggedIn: pb.authStore.isValid,
      user: pb.authStore.record,

      init() {
        pb.authStore.onChange((token, model) => {
          this.isLoggedIn = pb.authStore.isValid;
          this.user = model;
          document.cookie = pb.authStore.exportToCookie({ httpOnly: false });
        });
      },

      async login() {
        try {
          await pb.collection("users").authWithOAuth2({ provider: "google" });
        } catch (err) {
          console.error("Login failed", err);
        }
      },

      logout() {
        pb.authStore.clear();
      },

      get avatarUrl() {
        if (this.user?.avatar) {
          return `${pb.baseUrl}/api/files/${this.user.collectionId}/${this.user.id}/${this.user.avatar}`;
        }
        return `https://ui-avatars.com/api/?name=${this.user?.name || "User"}&background=random`;
      },
    });

    Alpine.start();
  }

  // Mobile Menu Logic
  const menuBtn = document.getElementById("mobile-menu-btn");
  const closeBtn = document.getElementById("close-menu-btn");
  const menu = document.getElementById("mobile-menu");

  function toggleMenu() {
    if (menu) {
      // Check if menu is currently hidden (has opacity-0)
      const isHidden = menu.classList.contains("opacity-0");

      if (isHidden) {
        // OPEN MENU
        menu.classList.remove("opacity-0", "pointer-events-none", "scale-95");
        menu.classList.add("opacity-100", "pointer-events-auto", "scale-100");
        document.body.style.overflow = "hidden"; // Prevent scrolling
      } else {
        // CLOSE MENU
        menu.classList.remove(
          "opacity-100",
          "pointer-events-auto",
          "scale-100",
        );
        menu.classList.add("opacity-0", "pointer-events-none", "scale-95");
        document.body.style.overflow = ""; // Restore scrolling
      }
    }
  }

  // Use 'click' directly, ensure elements exist
  if (menuBtn)
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu();
    });

  if (closeBtn)
    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu();
    });

  // Close when clicking links
  const mobileLinks = menu?.querySelectorAll("a");
  mobileLinks?.forEach((link) => {
    link.addEventListener("click", () => {
      if (!menu.classList.contains("opacity-0")) toggleMenu();
    });
  });
</script>
