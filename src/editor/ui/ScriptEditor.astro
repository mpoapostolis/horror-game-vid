<div
  id="script-editor-root"
  x-show="showScriptEditor"
  class="absolute inset-4 z-50 flex flex-col font-sans bg-[#1e1e1eba] backdrop-blur-md rounded-xl shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/10"
  style="display: none;"
  x-transition.opacity.duration.200ms
  x-cloak
  x-data="scriptEditor()"
  @keydown.escape.window="closeEditor()"
>
  <div
    class="flex-1 flex flex-col bg-[#1e1e1e] rounded-xl overflow-hidden border border-[#333] shadow-2xl ring-1 ring-white/10"
  >
    <div
      class="h-12 border-b border-[#333] bg-[#252526] flex items-center justify-between px-4 shrink-0 select-none"
    >
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-emerald-500">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg
          >
          <span class="font-bold tracking-wider text-sm">VXL PRO EDITOR</span>
        </div>
        <div class="h-4 w-px bg-[#444]"></div>
        <div class="text-xs text-gray-400 flex gap-2">
          <span>Editing:</span>
          <span
            x-text="entityName"
            class="text-gray-100 font-semibold bg-[#333] px-2 py-0.5 rounded"
          ></span>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <select
          @change="loadTemplate($event.target.value); $event.target.value = ''"
          class="appearance-none bg-[#333] text-gray-300 text-xs pl-3 pr-8 py-1.5 rounded border border-transparent hover:border-[#555] focus:border-emerald-500 outline-none cursor-pointer transition-all"
        >
          <option value="">Load Template...</option>
          <option value="tutorial">ğŸ”° Scripting Tutorial</option>
          <option value="shop">ğŸ’° Merchant Shop</option>
          <option value="dragon_slayer">ğŸ‰ Dragon Slayer (Quest)</option>
          <option value="riddle">ğŸ§™â€â™‚ï¸ Sphinx Riddle</option>
          <option value="door">ğŸšª Locked Door Check</option>
          <option value="healer">ğŸ¥ Healer Service</option>
          <option value="auto_flow">âš¡ Auto-Flow Example</option>
        </select>

        <div class="h-4 w-px bg-[#444]"></div>

        <button
          @click="closeEditor()"
          class="px-3 py-1.5 text-xs text-gray-400 hover:text-white hover:bg-[#333] rounded transition-colors"
          >Cancel</button
        >
        <button
          @click="saveScript()"
          class="px-4 py-1.5 text-xs font-bold rounded flex items-center gap-2 transition-all duration-200"
          :class="isSaving ? 'bg-emerald-700 text-emerald-100' : 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-[0_0_15px_rgba(16,185,129,0.4)]'"
        >
          <span x-text="isSaving ? 'SAVED' : 'SAVE CHANGES'"></span>
          <span
            x-show="!isSaving"
            class="opacity-60 font-normal text-[10px] bg-black/20 px-1 rounded ml-1"
            >âŒ˜S</span
          >
        </button>
      </div>
    </div>

    <div class="flex-1 relative bg-[#1e1e1e]" id="monaco-container"></div>

    <div
      class="h-6 text-white text-[10px] flex items-center justify-between px-3 shrink-0 select-none transition-colors duration-300"
      :class="errorCount > 0 ? 'bg-red-600 animate-pulse' : 'bg-emerald-600'"
    >
      <div class="flex items-center gap-4">
        <span class="flex items-center gap-1"
          ><span class="opacity-70">Ln</span>
          <span x-text="cursorLine">1</span>, <span class="opacity-70">Col</span
          >
          <span x-text="cursorCol">1</span></span
        >
        <span class="opacity-50">|</span>
        <span
          x-show="errorCount > 0"
          class="text-red-100 font-bold flex items-center gap-1 bg-red-500/20 px-1 rounded"
        >
          <span>âš ï¸</span>
          <span x-text="errorCount"></span> Errors
        </span>
        <span x-show="errorCount === 0" class="flex items-center gap-1"
          ><span>âœ”ï¸</span> Valid Script</span
        >
      </div>
      <div class="opacity-80">VXL Intellisense Enabled</div>
    </div>
  </div>
</div>

<script>
  import * as monaco from "monaco-editor";

  // --- 1. THE MASSIVE DATABASE (100+ Items) ---
  const GAME_DB: Record<string, { type: string; desc: string }> = {
    // Stats & Attributes
    hp: { type: "Stat", desc: "â¤ï¸ Current Health Points" },
    max_hp: { type: "Stat", desc: "ğŸ©¸ Maximum Health Cap" },
    mp: { type: "Stat", desc: "âœ¨ Mana/Magic Points" },
    stamina: { type: "Stat", desc: "ğŸ”‹ Physical Energy" },
    xp: { type: "Stat", desc: "ğŸ“– Experience Points" },
    level: { type: "Stat", desc: "ğŸ† Character Level" },
    karma: { type: "Stat", desc: "âš–ï¸ Alignment (-100 to 100)" },
    strength: { type: "Attribute", desc: "ğŸ’ª Physical Power" },
    dexterity: { type: "Attribute", desc: "âš¡ Speed and Agility" },
    intelligence: { type: "Attribute", desc: "ğŸ§  Magic/Mental Power" },
    luck: { type: "Attribute", desc: "ğŸ€ Critical chance and loot drops" },

    // Currencies
    gold: { type: "Currency", desc: "ğŸ’° Standard Gold Coins" },
    gems: { type: "Currency", desc: "ğŸ’ Premium Currency" },
    silver: { type: "Currency", desc: "ğŸª™ Lesser Coinage" },
    tokens: { type: "Currency", desc: "ğŸŸï¸ Event Tokens" },

    // Weapons (Swords)
    sword_rusty: { type: "Weapon", desc: "ğŸ—¡ï¸ Old rusty blade. DMG: 5" },
    sword_iron: { type: "Weapon", desc: "âš”ï¸ Standard soldier sword. DMG: 12" },
    sword_steel: { type: "Weapon", desc: "âš”ï¸ Refined steel sword. DMG: 20" },
    sword_excalibur: { type: "Legendary", desc: "âœ¨ The Holy Blade. DMG: 100" },
    dagger_shadow: { type: "Weapon", desc: "ğŸ”ª Assassin's blade. Fast / Crit" },
    axe_battle: { type: "Weapon", desc: "ğŸª“ Heavy double-edged axe. DMG: 35" },
    staff_mage: { type: "Weapon", desc: "ğŸ§™â€â™‚ï¸ Wooden staff. +10 INT" },
    bow_long: { type: "Weapon", desc: "ğŸ¹ Ranged weapon. Req: Arrow" },
    hammer_war: { type: "Weapon", desc: "ğŸ”¨ Crushing hammer. DMG: 45" },

    // Armor
    shield_wood: { type: "Armor", desc: "ğŸ›¡ï¸ Basic wooden shield" },
    shield_iron: { type: "Armor", desc: "ğŸ›¡ï¸ Sturdy iron shield" },
    helmet_iron: { type: "Armor", desc: "ğŸª– Protects the head" },
    chest_plate: { type: "Armor", desc: "ğŸ§¥ Heavy iron chestplate" },
    boots_leather: { type: "Armor", desc: "ğŸ¥¾ Soft leather boots" },
    gauntlets_steel: { type: "Armor", desc: "ğŸ§¤ Heavy steel protection" },

    // Consumables
    potion_hp_small: { type: "Potion", desc: "ğŸ§ª Heals 25 HP" },
    potion_hp_large: { type: "Potion", desc: "ğŸ§ª Heals 100 HP" },
    potion_mp_small: { type: "Potion", desc: "ğŸ§ª Restores 25 Mana" },
    potion_elixir: { type: "Potion", desc: "ğŸ§ª Full HP/MP Restore" },
    food_bread: { type: "Food", desc: "ğŸ Fresh bread. Heals 5 HP" },
    food_meat: { type: "Food", desc: "ğŸ– Cooked steak. Heals 20 HP" },
    food_apple: { type: "Food", desc: "ğŸ Tasty fruit. Heals 2 HP" },
    herb_red: { type: "Material", desc: "ğŸŒ¿ Used for HP potions" },
    herb_blue: { type: "Material", desc: "ğŸŒ¿ Used for MP potions" },

    // Materials
    mat_wood: { type: "Material", desc: "ğŸªµ Raw timber" },
    mat_stone: { type: "Material", desc: "ğŸª¨ Construction stone" },
    mat_iron_ore: { type: "Material", desc: "â›ï¸ Unrefined iron" },
    mat_leather: { type: "Material", desc: "ğŸ„ Raw animal hide" },
    mat_cloth: { type: "Material", desc: "ğŸ§µ Useful for tailoring" },
    mat_essence: { type: "Material", desc: "ğŸ”® Pure magical energy" },

    // Quest Items
    key_dungeon: { type: "Quest", desc: "ğŸ—ï¸ Opens the local dungeon" },
    key_chest: { type: "Quest", desc: "ğŸ”‘ Opens a treasure chest" },
    relic_ancient: { type: "Quest", desc: "ğŸº A dusty old artifact" },
    map_treasure: { type: "Quest", desc: "ğŸ“œ X marks the spot!" },
    letter_king: { type: "Quest", desc: "âœ‰ï¸ A royal message" },
    dragon_head: { type: "Quest", desc: "ğŸ‰ Proof of the kill" },
    gem_red: { type: "Quest", desc: "ğŸ”´ A glowing crimson gem" },
    gem_blue: { type: "Quest", desc: "ğŸ”µ A glowing cobalt gem" },

    // Trash / Misc
    junk_bone: { type: "Misc", desc: "ğŸ¦´ A bleached white bone" },
    junk_dust: { type: "Misc", desc: "ğŸ’¨ Just a pile of dust" },
    junk_feather: { type: "Misc", desc: "ğŸª¶ A bird feather" },
    junk_scrap: { type: "Misc", desc: "âš™ï¸ Rusty metal scraps" },
    junk_trash: { type: "Misc", desc: "ğŸ—‘ï¸ Useless garbage" },

    // Monsters/Drops (Extra logic vars)
    wolf_fur: { type: "Drop", desc: "ğŸº Warm grey fur" },
    spider_eye: { type: "Drop", desc: "ğŸ‘ï¸ Creepy and useful for alchemy" },
    slime_gel: { type: "Drop", desc: "ğŸ’§ Sticky blue goo" },
    rat_tail: { type: "Drop", desc: "ğŸ€ Gross, but someone might want it" },

    // Skills/Spells
    spell_fireball: { type: "Spell", desc: "ğŸ”¥ Casts a burst of fire" },
    spell_heal: { type: "Spell", desc: "âœ¨ Mend wounds with magic" },
    skill_dash: { type: "Skill", desc: "ğŸ’¨ Quick evasion move" },
    skill_strike: { type: "Skill", desc: "âš”ï¸ A heavy focused blow" },

    // World States (Flags & Quest Progress)
    quest_active: { type: "Flag", desc: "ğŸš© Currently on a mission" },
    quest_done: { type: "Flag", desc: "âœ… Mission accomplished" },
    quest_dragon_active: { type: "Flag", desc: "ğŸ² Hunting the Dragon" },
    quest_dragon_dead: { type: "Flag", desc: "ğŸ’€ The Dragon is slain" },
    quest_rats_active: { type: "Flag", desc: "ï¿½ Clearing the cellar" },
    quest_rats_done: { type: "Flag", desc: "ğŸŒ¾ The farm is safe" },
    gate_open: { type: "Flag", desc: "ï¿½ï¿½ Village gate is open" },
    boss_dead: { type: "Flag", desc: "ğŸ’€ The area boss is defeated" },
    night_mode: { type: "Flag", desc: "ğŸŒ™ It is currently night" },

    // Special Quest Items
    key_dragon_lair: { type: "Quest", desc: "ğŸ”¥ Ancient obsidian key" },
    emblem: { type: "Quest", desc: "ğŸ›¡ï¸ Royal Messenger Emblem" },
    rat_tails: { type: "Quest", desc: "ğŸ€ Gross, but Farmer needs proof" },
    potion_healing: { type: "Potion", desc: "ğŸ§ª Restore health via herbs" },

    // Add 20 more generic items for depth
    ...Object.fromEntries(
      Array.from({ length: 30 }, (_, i) => [
        `rare_artifact_${i + 1}`,
        { type: "Rare", desc: `âœ¨ Unique artifact #${i + 1}` },
      ]),
    ),
    ...Object.fromEntries(
      Array.from({ length: 30 }, (_, i) => [
        `resource_node_${i + 1}`,
        { type: "Node", desc: `ğŸ“ Gathering node #${i + 1}` },
      ]),
    ),
  };

  const VAR_NAMES = Object.keys(GAME_DB);

  // --- 2. EDITOR CONFIG ---
  const LANG_ID = "vxl-script-pro";

  if (!monaco.languages.getLanguages().some((l) => l.id === LANG_ID)) {
    monaco.languages.register({ id: LANG_ID });

    monaco.languages.setMonarchTokensProvider(LANG_ID, {
      tokenizer: {
        root: [
          [/\$[a-zA-Z0-9_]+/, "variable.game"],
          [/^#\s+[a-zA-Z0-9_]+/, "keyword.block"],

          // Actions: [give item], [set var]
          [/\[(give|take|set)\b/, "keyword.action"],
          [/\[/, "keyword.action"],
          [/\]/, "keyword.action"],

          // Flow: -> TARGET
          [/->\s*[a-zA-Z0-9_]+/, "keyword.flow"],

          // Choice: * Option
          [/^\*\s+/, "operator.choice"],

          // Dialogue: Speaker:
          [/^[a-zA-Z0-9_ ]+:/, "type.identifier"],

          // Conditions: Handle full block (need 5 $gold)
          [/\(need\s+[^)]+\)/, "annotation.condition"],

          [/\/\/.*/, "comment"],
          [/\d+/, "number"],
        ],
      },
    });

    monaco.editor.defineTheme("vxl-ultimate", {
      base: "vs-dark",
      inherit: true,
      rules: [
        { token: "variable.game", foreground: "FFD700", fontStyle: "bold" },
        { token: "keyword.block", foreground: "c586c0", fontStyle: "bold" },
        { token: "keyword.command", foreground: "4ec9b0", fontStyle: "bold" },
        { token: "string.target", foreground: "ce9178" },
        { token: "type.identifier", foreground: "569cd6", fontStyle: "bold" },
        { token: "comment", foreground: "6a9955", fontStyle: "italic" },
      ],
      colors: {
        "editor.background": "#1e1e1e",
        "editor.lineHighlightBackground": "#2a2d2e",
      },
    });

    monaco.languages.registerCompletionItemProvider(LANG_ID, {
      triggerCharacters: ["$", ">", " "],
      provideCompletionItems: (model, position) => {
        const word = model.getWordUntilPosition(position);
        const lineContent = model.getLineContent(position.lineNumber);
        const textUntilCursor = lineContent.substring(0, position.column);

        // --- 1. VARIABLE AUTOCOMPLETE (Trigger on $) ---
        // Special check: are we immediately after a $ or currently typing a variable?
        const lastDollarIndex = textUntilCursor.lastIndexOf("$");
        const lastSpaceIndex = textUntilCursor.lastIndexOf(" ");

        if (lastDollarIndex !== -1 && lastDollarIndex >= lastSpaceIndex) {
          const suggestions = VAR_NAMES.map((name) => {
            const item = GAME_DB[name];
            let kind = monaco.languages.CompletionItemKind.Variable;
            let icon = "ğŸ’"; // Default

            if (item.type === "Weapon") {
              icon = "âš”ï¸";
              kind = monaco.languages.CompletionItemKind.Enum;
            } else if (item.type === "Stat") {
              icon = "ğŸ“ˆ";
              kind = monaco.languages.CompletionItemKind.Field;
            } else if (item.type === "Currency") {
              icon = "ğŸ’°";
              kind = monaco.languages.CompletionItemKind.Value;
            } else if (item.type === "Quest") {
              icon = "ï¿½";
              kind = monaco.languages.CompletionItemKind.Struct;
            } else if (item.type === "Potion") {
              icon = "ğŸ§ª";
              kind = monaco.languages.CompletionItemKind.Color;
            } else if (item.type === "Food") {
              icon = "ğŸ";
              kind = monaco.languages.CompletionItemKind.Module;
            } else if (item.type === "Flag") {
              icon = "ï¿½";
              kind = monaco.languages.CompletionItemKind.TypeParameter;
            } else if (item.type === "Spell") {
              icon = "ğŸª„";
              kind = monaco.languages.CompletionItemKind.Function;
            } else if (item.type === "Material") {
              icon = "ğŸ—ï¸";
              kind = monaco.languages.CompletionItemKind.Unit;
            } else if (item.type === "Drop") {
              icon = "ğŸº";
              kind = monaco.languages.CompletionItemKind.Interface;
            }

            // Override icon if description starts with an emoji
            const emojiMatch = item.desc.match(
              /^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/u,
            );
            if (emojiMatch) icon = emojiMatch[0];

            return {
              label: `${icon} $${name}`,
              kind: kind,
              insertText: name,
              detail: `[${item.type}]`,
              documentation: item.desc,
              range: {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn,
              },
            };
          });
          return { suggestions };
        }

        // --- 2. JUMP TARGET AUTOCOMPLETE (Trigger on '-> ') ---
        if (textUntilCursor.trim().endsWith("->")) {
          const blocks: string[] = [];
          const text = model.getValue();
          const lines = text.split("\n");
          lines.forEach((l) => {
            const m = l.match(/^#\s+([a-zA-Z0-9_]+)/);
            if (m) blocks.push(m[1]);
          });

          const suggestions = blocks.map((b) => ({
            label: `ğŸš© # ${b}`,
            kind: monaco.languages.CompletionItemKind.Reference,
            insertText: b,
            detail: "Story Block",
            range: {
              startLineNumber: position.lineNumber,
              endLineNumber: position.lineNumber,
              startColumn: word.startColumn,
              endColumn: word.endColumn,
            },
          }));

          suggestions.push({
            label: "ğŸ›‘ END",
            kind: monaco.languages.CompletionItemKind.Keyword,
            insertText: "END",
            detail: "Terminate",
            range: {
              startLineNumber: position.lineNumber,
              endLineNumber: position.lineNumber,
              startColumn: word.startColumn,
              endColumn: word.endColumn,
            },
          });

          return { suggestions };
        }

        // --- 3. COMMAND SNIPPETS & GENERAL ---
        return {
          suggestions: [
            {
              label: "CHOICE",
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText:
                "* ${1:Option} -> ${2:TARGET}\n* ${3:Option} (need 50 gold) -> ${4:TARGET}",
              insertTextRules:
                monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Player Choices",
              range: {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn,
              },
            },
            {
              label: "GIVE [Action]",
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText: "[give ${1:item_name} ${2:1}]",
              insertTextRules:
                monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Give Item to Player",
              range: {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn,
              },
            },
            {
              label: "TAKE [Action]",
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText: "[take ${1:item_name} ${2:1}]",
              insertTextRules:
                monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Remove Item from Player",
              range: {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn,
              },
            },
            {
              label: "SET [Action]",
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText: "[set ${1:variable_name} ${2:1}]",
              insertTextRules:
                monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Set Global Variable",
              range: {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn,
              },
            },
            {
              label: "NEW BLOCK (#)",
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText:
                "# ${1:BLOCK_NAME}\n${2:Speaker}: ${3:Dialogue...}\n-> ${4:END}",
              insertTextRules:
                monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Create logic block",
              range: {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn,
              },
            },
          ],
        };
      },
    });

    monaco.languages.registerHoverProvider(LANG_ID, {
      provideHover: (model, position) => {
        const word = model.getWordAtPosition(position);
        if (word && GAME_DB[word.word]) {
          const item = GAME_DB[word.word];
          return {
            contents: [
              { value: `**$${word.word}**` },
              { value: `*${item.type}*` },
              { value: item.desc },
            ],
          };
        }
      },
    });
  }

  // --- 3. SINGLETON EDITOR INSTANCE (CRITICAL FOR PERFORMANCE) ---
  let singletonEditor: monaco.editor.IStandaloneCodeEditor | null = null;
  let validationTimeout: any = null;

  const validateScript = (model: monaco.editor.ITextModel) => {
    const text = model.getValue();
    const markers: monaco.editor.IMarkerData[] = [];
    const lines = text.split("\n");
    const blocks = new Set<string>();

    lines.forEach((line) => {
      const m = line.match(/^#\s+([a-zA-Z0-9_]+)/);
      if (m) blocks.add(m[1]);
    });

    lines.forEach((line, i) => {
      const varMatches = line.matchAll(/\$([a-zA-Z0-9_]+)/g);
      for (const match of varMatches) {
        if (!GAME_DB[match[1]]) {
          markers.push({
            severity: monaco.MarkerSeverity.Error,
            message: `Unknown variable '$${match[1]}'`,
            startLineNumber: i + 1,
            startColumn: match.index! + 1,
            endLineNumber: i + 1,
            endColumn: match.index! + 1 + match[0].length,
          });
        }
      }
      const jumpMatches = line.matchAll(/->\s+([a-zA-Z0-9_]+)/g);
      for (const jumpMatch of jumpMatches) {
        const target = jumpMatch[1];
        if (
          // Ignore command keywords if accidentally matched as targets?
          // But our blocks set check handles that.
          !blocks.has(target) &&
          !["END"].includes(target)
        ) {
          markers.push({
            severity: monaco.MarkerSeverity.Error,
            message: `Missing story block: '# ${target}'`,
            startLineNumber: i + 1,
            startColumn: jumpMatch.index! + 3,
            endLineNumber: i + 1,
            endColumn: jumpMatch.index! + 3 + target.length,
          });
        }
      }
    });

    monaco.editor.setModelMarkers(model, LANG_ID, markers);
    return markers.length;
  };

  // --- ALPINE ---
  document.addEventListener("alpine:init", () => {
    // @ts-ignore
    Alpine.data("scriptEditor", () => ({
      showScriptEditor: false,
      activeEntityId: -1,
      entityName: "",
      isSaving: false,
      cursorLine: 1,
      cursorCol: 1,
      errorCount: 0,

      init() {
        // @ts-ignore
        window.openScriptEditor = (id) => {
          this.activeEntityId = id;
          this.showScriptEditor = true;

          // @ts-ignore
          const ent = window.getEditorEntity
            ? window.getEditorEntity(id)
            : null;
          this.entityName = ent?.name || "Entity_" + id;

          const script = ent?.scriptSource || "";
          setTimeout(() => this.initMonaco(script), 0);
        };
      },

      closeEditor() {
        this.showScriptEditor = false;
      },

      initMonaco(initialValue: string) {
        const container = document.getElementById("monaco-container");
        if (!container) return;

        if (!singletonEditor) {
          singletonEditor = monaco.editor.create(container, {
            value: initialValue,
            language: LANG_ID,
            theme: "vxl-ultimate",
            automaticLayout: true,
            minimap: { enabled: true },
            fontSize: 14,
            fontFamily: "'Fira Code', monospace",
            padding: { top: 20 },
            scrollBeyondLastLine: false,
          });

          singletonEditor.onDidChangeCursorPosition((e) => {
            this.cursorLine = e.position.lineNumber;
            this.cursorCol = e.position.column;
          });

          singletonEditor.onDidChangeModelContent(() => {
            if (validationTimeout) clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => {
              if (singletonEditor) {
                this.errorCount = validateScript(singletonEditor.getModel()!);
              }
            }, 500); // 500ms debounce
          });
        } else {
          singletonEditor.setValue(initialValue);
        }

        this.errorCount = validateScript(singletonEditor.getModel()!);
      },

      templates: {
        tutorial: `# START\n// Lines starting with '#' are BLOCKS.\n// This block is named 'START'.\nGuide: Welcome to script writing!\nGuide: Use '*' for choices and '[]' for actions.\n* Tell me more -> EXPLAIN\n* I'm ready to write -> END\n\n# EXPLAIN\nGuide: You can check variables like gold or items.\nGuide: Example: (need 50 $gold)\n-> END`,

        shop: `# START\nMerchant: Finest wares in the land!\n* Buy Iron Sword (50g) (need 50 $gold) -> BUY_SWORD\n* Buy Potion (10g) (need 10 $gold) -> BUY_POTION\n* Just looking -> LEAVE\n\n# BUY_SWORD\n[take 50 $gold]\n[give $sword_iron]\nMerchant: A sharp choice. It will serve you well.\n-> END\n\n# BUY_POTION\n[take 10 $gold]\n[give $potion_healing]\nMerchant: Stay healthy out there!\n-> END\n\n# LEAVE\nMerchant: Come back when you have coin.\n-> END`,

        dragon_slayer: `# START\n// Check State\n* (need 1 $quest_dragon_dead) -> HERO\n* (need 1 $quest_dragon_active) -> RETURN\n\n// Intro\nKing: A Dragon plagues our lands!\n* I will slay it! -> ACCEPT\n* Sounds dangerous -> COWARD\n\n# ACCEPT\nKing: Take this key to the lair.\n[give $key_dragon_lair]\n[set $quest_dragon_active 1]\n-> END\n\n# COWARD\nKing: Then we are doomed.\n-> END\n\n# RETURN\n// Auto-complete if players has the head\n-> VICTORY (need 1 $dragon_head)\n\nKing: Have you slain the beast?\n-> END\n\n# VICTORY\n[take $dragon_head]\n[set $quest_dragon_active 0]\n[set $quest_dragon_dead 1]\n[give $gold 5000]\n[give $sword_excalibur]\nKing: You are the Savior of the Realm!\n-> END\n\n# HERO\nKing: All hail the Dragon Slayer!\n-> END`,

        riddle: `# START\nSphinx: I have a riddle for you.\nSphinx: What walks on 4 legs in the morning,\nSphinx: 2 at noon, and 3 in the evening?\n* A Human -> CORRECT\n* A Dog -> WRONG\n* A Spider -> WRONG\n\n# CORRECT\nSphinx: You are wise indeed.\n[give $intelligence 1]\n-> END\n\n# WRONG\nSphinx: Foolish mortal!\n[take $hp 10]\n-> END`,

        door: `# START\nNarrator: A heavy iron door blocks the way.\n* [STR] Force it Open (need 15 $strength) -> OPEN_FORCE\n* [KEY] Use Dungeon Key (need 1 $key_dungeon) -> OPEN_KEY\n* Leave -> END\n\n# OPEN_FORCE\nNarrator: You strain your muscles... and the door gives way!\n-> END\n\n# OPEN_KEY\nNarrator: The key turns smoothly. Click.\n-> END`,

        healer: `# START\nPriest: You look wounded, child.\n* Heal me (50g) (need 50 $gold) -> HEAL\n* I'm fine -> END\n\n# HEAL\n[take 50 $gold]\n[set $hp 100]\nPriest: Light be with you.\n-> END`,

        auto_flow: `# START\nNPC: I need a Red Gem.\n// If player has it, jump immediately\n-> THANKS (need 1 $gem_red)\nNPC: Please find one for me.\n-> END\n\n# THANKS\n[take $gem_red]\n[give $gold 100]\nNPC: Oh! You already have it! Amazing!\n-> END`,
      } as Record<string, string>,

      loadTemplate(key: string) {
        if (!key || !this.templates[key] || !singletonEditor) return;
        if (confirm("Replace current script with template?")) {
          singletonEditor.setValue(this.templates[key]);
        }
      },

      saveScript() {
        if (!singletonEditor) return;
        this.isSaving = true;
        const scriptValue = singletonEditor.getValue();

        window.dispatchEvent(
          new CustomEvent("save-script", {
            detail: {
              id: this.activeEntityId,
              script: scriptValue,
            },
          }),
        );

        setTimeout(() => (this.isSaving = false), 800);
      },
    }));
  });
</script>
